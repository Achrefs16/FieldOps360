# FieldOps360 - CI Pipeline
# Runs on every push and PR to develop/main

name: CI

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  # ============================================================
  # DETECT WHICH SERVICES CHANGED
  # ============================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      project: ${{ steps.filter.outputs.project }}
      resource: ${{ steps.filter.outputs.resource }}
      planning: ${{ steps.filter.outputs.planning }}
      reporting: ${{ steps.filter.outputs.reporting }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'services/auth-service/**'
            project:
              - 'services/project-service/**'
            resource:
              - 'services/resource-service/**'
            planning:
              - 'services/planning-service/**'
            reporting:
              - 'services/reporting-service/**'
            infra:
              - 'infra/**'

  # ============================================================
  # LINT & TYPE-CHECK (only changed services)
  # ============================================================
  lint-test:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/auth-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/auth-service/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma clients
        run: |
          npx prisma generate --schema=prisma/platform/schema.prisma
          npx prisma generate --schema=prisma/tenant/schema.prisma

      - name: Type-check
        run: npx tsc --noEmit

  # ============================================================
  # BUILD & PUSH TO DOCKER HUB (only changed services)
  # ============================================================
  build-push:
    needs: detect-changes
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: auth-service
            changed: ${{ needs.detect-changes.outputs.auth }}
          - service: project-service
            changed: ${{ needs.detect-changes.outputs.project }}
          - service: resource-service
            changed: ${{ needs.detect-changes.outputs.resource }}
          - service: planning-service
            changed: ${{ needs.detect-changes.outputs.planning }}
          - service: reporting-service
            changed: ${{ needs.detect-changes.outputs.reporting }}
    steps:
      - uses: actions/checkout@v4
        if: matrix.changed == 'true'

      - name: Login to Docker Hub
        if: matrix.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push to Docker Hub
        if: matrix.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: services/${{ matrix.service }}
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/fieldops-${{ matrix.service }}:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/fieldops-${{ matrix.service }}:latest

  # ============================================================
  # TERRAFORM VALIDATE (if infra changed)
  # ============================================================
  terraform-validate:
    needs: detect-changes
    if: needs.detect-changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra/terraform
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform fmt -check
      - run: terraform init -backend=false
      - run: terraform validate
