# FieldOps360 - CD Pipeline
# Deploys to K3s after CI passes

name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [develop, main]

jobs:
  deploy-dev:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to dev namespace
        run: |
          NAMESPACE="fieldops-dev"
          TAG="${{ github.event.workflow_run.head_sha }}"
          DOCKER_USER="${{ secrets.DOCKERHUB_USERNAME }}"

          for SERVICE in auth-service project-service resource-service planning-service reporting-service; do
            if kubectl get deployment $SERVICE -n $NAMESPACE 2>/dev/null; then
              kubectl set image deployment/$SERVICE \
                $SERVICE=$DOCKER_USER/fieldops-$SERVICE:$TAG \
                -n $NAMESPACE
              kubectl rollout status deployment/$SERVICE -n $NAMESPACE --timeout=120s
            fi
          done

      - name: Status
        run: kubectl get pods -n fieldops-dev

  deploy-prod:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: self-hosted
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to prod namespace
        run: |
          NAMESPACE="fieldops-prod"
          TAG="${{ github.event.workflow_run.head_sha }}"
          DOCKER_USER="${{ secrets.DOCKERHUB_USERNAME }}"

          for SERVICE in auth-service project-service resource-service planning-service reporting-service; do
            if kubectl get deployment $SERVICE -n $NAMESPACE 2>/dev/null; then
              kubectl set image deployment/$SERVICE \
                $SERVICE=$DOCKER_USER/fieldops-$SERVICE:$TAG \
                -n $NAMESPACE
              kubectl rollout status deployment/$SERVICE -n $NAMESPACE --timeout=180s
            fi
          done

      - name: Status
        run: kubectl get pods -n fieldops-prod
